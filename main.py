import json
import random
import requests
import schedule
import time
from datetime import datetime, timedelta
import os
import logging

# تنظیمات لاگینگ
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

# Bot configuration
token = "bot347312:925cb350-f0b4-43fd-96e4-204763b58135"
chat_id = "10362318"
base_url = f"https://eitaayar.ir/api/{token}"


# مسیر فایل JSON اوقات شرعی (با مسیر نسبی)
base_dir = os.path.dirname(os.path.abspath(__file__))  # مسیر دایرکتوری فعلی (پوشه‌ی پروژه)
prayer_times_file = os.path.join(base_dir, "data", "20.json")  # مسیر فایل JSON
START_DAY = 318  # روز شروع

# مسیر پوشه‌ی audio_files (با مسیر نسبی)
audio_files_path = os.path.join(base_dir, "audio_files")

# چاپ مسیرها برای بررسی
logging.info(f"مسیر دایرکتوری پروژه: {base_dir}")
logging.info(f"مسیر پوشه‌ی audio_files: {audio_files_path}")
logging.info(f"مسیر فایل اوقات شرعی: {prayer_times_file}")
)

# نام نمازها به فارسی
prayer_names = {
    "fajr": "صبح",
    "dhuhr": "ظهر",
    "asr": "عصر",
    "maghrib": "مغرب",
    "isha": "عشاء"
}

# لیست پیام‌های تصادفی
random_messages = [
    "🌟 وقت نماز است! بیا و با نمازت قلب خود را روشن کن. 🌟",
    "🕋 لحظه‌ای با خدا باش، نمازت را به جا بیاور. 🕋",
    "🌙 نماز بهترین هدیه‌ای است که می‌توانی به خودت بدهی. 🌙",
    "🙏 با نماز، آرامش را به زندگیت دعوت کن. 🙏",
    "💫 نمازت را بخوان تا نور الهی در وجودت جاری شود. 💫",
    "🕌 وقت اذان است، بیا و در خانه خدا حضور پیدا کن. 🕌",
    "🌺 نماز، گل‌های بهشتی را در قلب تو می‌کارد. 🌺",
    "🕊️ با نماز، بال‌های آرامش را بر زندگی‌ات بگستران. 🕊️",
    "✨ نماز، بهترین راه برای نزدیکی به خداست. ✨",
    "🌿 نمازت را بخوان تا روح‌ات تازه شود. 🌿",
    "🕯️ نماز، نور راه زندگی‌ات است. 🕯️",
    "🌅 وقت اذان است، بیا و با نماز روزت را زیبا کن. 🌅",
    "🌈 نماز، رنگ‌های الهی را به زندگی‌ات می‌آورد. 🌈",
    "🌠 با نماز، ستاره‌های آرامش را در آسمان قلب‌ات روشن کن. 🌠",
    "🕋 نماز، بهترین لحظه‌های زندگی‌ات را می‌سازد. 🕋",
    "🌷 نمازت را بخوان تا گل‌های بهشت در قلب‌ت شکوفا شود. 🌷",
    "🌟 وقت اذان است، بیا و با نماز به خدا نزدیک شو. 🌟",
    "🕊️ نماز، بال‌های آرامش را بر زندگی‌ات می‌گستراند. 🕊️",
    "🌙 نماز، بهترین راه برای شروع یک روز زیباست. 🌙",
    "🙏 با نماز، قلب‌ات را با نور الهی روشن کن. 🙏"
]

# Helper functions
def send_message(text):
    url = f"{base_url}/sendMessage"
    payload = {
        "chat_id": chat_id,
        "text": text,
    }
    try:
        logging.info(f"در حال ارسال پیام: {text}")
        response = requests.post(url, json=payload)
        logging.info(f"پاسخ ارسال پیام: {response.status_code}")
        return response.json()
    except Exception as e:
        logging.error(f"خطا در ارسال پیام: {e}")
        return None

def send_voice(file_path, caption=""):
    url = f"{base_url}/sendFile"
    try:
        logging.info(f"در حال ارسال فایل صوتی: {file_path}")
        with open(file_path, "rb") as file:
            files = {"file": file}
            payload = {"chat_id": chat_id, "caption": caption}
            response = requests.post(url, files=files, data=payload)
        logging.info(f"پاسخ ارسال فایل صوتی: {response.status_code}")
        return response.json()
    except FileNotFoundError:
        logging.error(f"فایل صوتی یافت نشد: {file_path}")
        return None
    except Exception as e:
        logging.error(f"خطا در ارسال فایل صوتی: {e}")
        return None

# بارگذاری اطلاعات اوقات شرعی از فایل JSON
def load_prayer_times():
    try:
        with open(prayer_times_file, "r", encoding="utf-8") as file:
            data = json.load(file)
            daily_data = data['data']
            today_info = next((day for day in daily_data if day['day'] == START_DAY), None)
            if today_info:
                return today_info
            else:
                logging.error(f"اطلاعات روز {START_DAY} یافت نشد.")
                return None
    except Exception as e:
        logging.error(f"خطا در خواندن فایل اوقات شرعی: {e}")
        return None

# ارسال اوقات شرعی به صورت کلی در ابتدای روز
def send_daily_prayer_times():
    try:
        today_info = load_prayer_times()
        if today_info:
            message = f"""
            🕌 اوقات شرعی روز {today_info['day']}:
            🌅 اذان صبح: {today_info['fajr']}
            ☀️ طلوع آفتاب: {today_info['sunrise']}
            🕰️ اذان ظهر: {today_info['dhuhr']}
            🌇 اذان عصر: {today_info['asr']}
            🌃 اذان مغرب: {today_info['maghrib']}
            🌌 اذان عشاء: {today_info['isha']}
            """
            send_message(message)
        else:
            logging.warning("اطلاعات اوقات شرعی برای امروز یافت نشد.")
    except Exception as e:
        logging.error(f"خطا در ارسال اوقات شرعی روزانه: {e}")

# ارسال اوقات شرعی برای هر نماز در وقت مشخص
def send_prayer_time_notification(prayer_name, prayer_time):
    try:
        logging.info(f"در حال اطلاع‌رسانی زمان نماز: {prayer_name}")
        random_message = random.choice(random_messages)
        text = f"🕋 نماز {prayer_names[prayer_name]} 🕋\n⏰ زمان نماز: {prayer_time}\n\n{random_message}"
        send_message(text)
    except Exception as e:
        logging.error(f"خطا در اطلاع‌رسانی زمان نماز: {e}")

# ارسال پیام تشویقی نیم ساعت قبل از نماز
def send_reminder_notification(prayer_name, prayer_time):
    try:
        logging.info(f"در حال اطلاع‌رسانی نیم ساعت قبل از نماز: {prayer_name}")
        reminder_time = (datetime.strptime(prayer_time, "%H:%M:%S") - timedelta(minutes=30)).strftime("%H:%M:%S")
        text = f"⏳ نیم ساعت دیگر زمان نماز {prayer_names[prayer_name]} فرا می‌رسد. ⏳\n\n🕋 آماده شوید و با حضور قلب نماز را به جای آورید. 🌟\n\n💫 \"نماز ستون دین است، پس آن را با حضور قلب به جای آورید.\" 💫"
        send_message(text)
    except Exception as e:
        logging.error(f"خطا در اطلاع‌رسانی نیم ساعت قبل از نماز: {e}")

# ارسال دعاها
def send_supplication(voice_file, caption):
    logging.info(f"در حال ارسال دعا: {caption}")
    send_voice(voice_file, caption)

# ارسال آیه تصادفی
def random_quranic_verse():
    verses = [
        {
            "verse": "إِنَّ مَعَ الْعُسْرِ يُسْرًا",
            "interpretation": "🌟 تفسیر نور: هر سختی همراه با آسانی است. این آیه به ما امید می‌دهد که پس از هر مشکل، راه‌حلی وجود دارد."
        },
        {
            "verse": "وَمَنْ يَتَّقِ اللَّهَ يَجْعَلْ لَهُ مَخْرَجًا",
            "interpretation": "🌟 تفسیر انوارالقرآن: هر کس تقوای الهی پیشه کند، خداوند راه نجات را برای او فراهم می‌کند."
        },
        {
            "verse": "وَتَوَکَّلْ عَلَى الْحَیِّ الَّذِی لَا یَمُوتُ",
            "interpretation": "🌟 تفسیر نور: بر خداوند زنده‌ای که هرگز نمی‌میرد، توکل کن. این آیه به ما یادآوری می‌کند که تنها تکیه‌گاه ما خداست."
        },
        {
            "verse": "قُلْ هُوَ اللَّهُ أَحَدٌ",
            "interpretation": "🌟 تفسیر انوارالقرآن: بگو او الله یکتاست. این سوره بیانگر توحید و یگانگی خداوند است."
        },
        
    {
        "verse": "📖 اللَّهُ لَا إِلَٰهَ إِلَّا هُوَ الْحَيُّ الْقَيُّومُ ۚ لَا تَأْخُذُهُ سِنَةٌ وَلَا نَوْمٌ ۚ لَهُ مَا فِي السَّمَاوَاتِ وَمَا فِي الْأَرْضِ ۗ مَنْ ذَا الَّذِي يَشْفَعُ عِنْدَهُ إِلَّا بِإِذْنِهِ ۚ يَعْلَمُ مَا بَيْنَ أَيْدِيهِمْ وَمَا خَلْفَهُمْ ۖ وَلَا يُحِيطُونَ بِشَيْءٍ مِنْ عِلْمِهِ إِلَّا بِمَا شَاءَ ۚ وَسِعَ كُرْسِيُّهُ السَّمَاوَاتِ وَالْأَرْضَ ۖ وَلَا يَئُودُهُ حِفْظُهُمَا ۚ وَهُوَ الْعَلِيُّ الْعَظِيمُ",
        "interpretation": "🌟 این آیه عظمت و قدرت بی‌پایان خداوند را توصیف می‌کند. خداوند زنده و قائم به ذات است و هیچ‌کس بدون اجازه او نمی‌تواند شفاعت کند. علم او همه چیز را در بر می‌گیرد و حفظ آسمان‌ها و زمین برای او آسان است. 🌌"
    },
    {
        "verse": "📖 لَا يُكَلِّفُ اللَّهُ نَفْسًا إِلَّا وُسْعَهَا ۚ لَهَا مَا كَسَبَتْ وَعَلَيْهَا مَا اكْتَسَبَتْ ۗ رَبَّنَا لَا تُؤَاخِذْنَا إِنْ نَسِينَا أَوْ أَخْطَأْنَا ۚ رَبَّنَا وَلَا تَحْمِلْ عَلَيْنَا إِصْرًا كَمَا حَمَلْتَهُ عَلَى الَّذِينَ مِنْ قَبْلِنَا ۚ رَبَّنَا وَلَا تُحَمِّلْنَا مَا لَا طَاقَةَ لَنَا بِهِ ۖ وَاعْفُ عَنَّا وَاغْفِرْ لَنَا وَارْحَمْنَا ۚ أَنْتَ مَوْلَانَا فَانْصُرْنَا عَلَى الْقَوْمِ الْكَافِرِينَ",
        "interpretation": "🌿 خداوند به هرکس تنها به اندازه توانایی‌اش تکلیف می‌دهد. این آیه دعایی زیبا برای طلب آمرزش، رحمت و یاری از خداوند است. 🙏"
    },
    {
        "verse": "📖 شَهِدَ اللَّهُ أَنَّهُ لَا إِلَٰهَ إِلَّا هُوَ وَالْمَلَائِكَةُ وَأُولُو الْعِلْمِ قَائِمًا بِالْقِسْطِ ۚ لَا إِلَٰهَ إِلَّا هُوَ الْعَزِيزُ الْحَكِيمُ",
        "interpretation": "🕊️ خداوند، فرشتگان و صاحبان علم گواهی می‌دهند که هیچ معبودی جز او نیست. او عزیز و حکیم است و به عدالت برپاست. ✨"
    },
    {
        "verse": "📖 وَلْتَكُنْ مِنْكُمْ أُمَّةٌ يَدْعُونَ إِلَى الْخَيْرِ وَيَأْمُرُونَ بِالْمَعْرُوفِ وَيَنْهَوْنَ عَنِ الْمُنْكَرِ ۚ وَأُولَٰئِكَ هُمُ الْمُفْلِحُونَ",
        "interpretation": "🌺 این آیه دعوت به تشکیل جامعه‌ای می‌کند که به خیر دعوت کند، امر به معروف و نهی از منکر نماید. چنین افرادی رستگار خواهند بود. 🌟"
    },
    {
        "verse": "📖 وَالَّذِينَ إِذَا فَعَلُوا فَاحِشَةً أَوْ ظَلَمُوا أَنْفُسَهُمْ ذَكَرُوا اللَّهَ فَاسْتَغْفَرُوا لِذُنُوبِهِمْ وَمَنْ يَغْفِرُ الذُّنُوبَ إِلَّا اللَّهُ وَلَمْ يُصِرُّوا عَلَىٰ مَا فَعَلُوا وَهُمْ يَعْلَمُونَ",
        "interpretation": "💧 این آیه درباره توبه کنندگانی است که پس از ارتکاب گناه، به یاد خدا می‌افتند و استغفار می‌کنند. خداوند تنها کسی است که گناهان را می‌بخشد. 🌈"
    },
    {
        "verse": "📖 فَبِمَا رَحْمَةٍ مِنَ اللَّهِ لِنْتَ لَهُمْ ۖ وَلَوْ كُنْتَ فَظًّا غَلِيظَ الْقَلْبِ لَانْفَضُّوا مِنْ حَوْلِكَ ۖ فَاعْفُ عَنْهُمْ وَاسْتَغْفِرْ لَهُمْ وَشَاوِرْهُمْ فِي الْأَمْرِ ۖ فَإِذَا عَزَمْتَ فَتَوَكَّلْ عَلَى اللَّهِ ۚ إِنَّ اللَّهَ يُحِبُّ الْمُتَوَكِّلِينَ",
        "interpretation": "🤝 این آیه به پیامبر(ص) توصیه می‌کند که با مردم با نرمی رفتار کند، از آن‌ها درخواست عفو نماید و در امور با آن‌ها مشورت کند. توکل بر خداوند پس از تصمیم‌گیری نیز مورد تأکید است. 🌟"
    },
    {
        "verse": "📖 يَا أَيُّهَا الَّذِينَ آمَنُوا لَا تَأْكُلُوا أَمْوَالَكُمْ بَيْنَكُمْ بِالْبَاطِلِ إِلَّا أَنْ تَكُونَ تِجَارَةً عَنْ تَرَاضٍ مِنْكُمْ ۚ وَلَا تَقْتُلُوا أَنْفُسَكُمْ ۚ إِنَّ اللَّهَ كَانَ بِكُمْ رَحِيمًا",
        "interpretation": "💰 این آیه به مؤمنان هشدار می‌دهد که اموال یکدیگر را به ناحق نخورند و از خودکشی بپرهیزند. خداوند نسبت به بندگانش مهربان است. ❤️"
    },
    {
        "verse": "📖 وَاعْبُدُوا اللَّهَ وَلَا تُشْرِكُوا بِهِ شَيْئًا ۖ وَبِالْوَالِدَيْنِ إِحْسَانًا وَبِذِي الْقُرْبَىٰ وَالْيَتَامَىٰ وَالْمَسَاكِينِ وَالْجَارِ ذِي الْقُرْبَىٰ وَالْجَارِ الْجُنُبِ وَالصَّاحِبِ بِالْجَنْبِ وَابْنِ السَّبِيلِ وَمَا مَلَكَتْ أَيْمَانُكُمْ ۗ إِنَّ اللَّهَ لَا يُحِبُّ مَنْ كَانَ مُخْتَالًا فَخُورًا",
        "interpretation": "❤️ این آیه به عبادت خداوند و نیکی به والدین، خویشاوندان، یتیمان، فقرا و همسایگان تأکید می‌کند. خداوند از افراد متکبر و فخرفروش بیزار است. 🌸"
    },
    {
        "verse": "📖 يَا أَيُّهَا الَّذِينَ آمَنُوا كُونُوا قَوَّامِينَ بِالْقِسْطِ شُهَدَاءَ لِلَّهِ وَلَوْ عَلَىٰ أَنْفُسِكُمْ أَوِ الْوَالِدَيْنِ وَالْأَقْرَبِينَ ۚ إِنْ يَكُنْ غَنِيًّا أَوْ فَقِيرًا فَاللَّهُ أَوْلَىٰ بِهِمَا ۖ فَلَا تَتَّبِعُوا الْهَوَىٰ أَنْ تَعْدِلُوا ۚ وَإِنْ تَلْوُوا أَوْ تُعْرِضُوا فَإِنَّ اللَّهَ كَانَ بِمَا تَعْمَلُونَ خَبِيرًا",
        "interpretation": "⚖️ این آیه به عدالت و شهادت به حق حتی علیه خود یا نزدیکان تأکید می‌کند. خداوند از همه اعمال ما آگاه است. 🌟"
    },
    {
        "verse": "📖 وَلَقَدْ أَخَذَ اللَّهُ مِيثَاقَ بَنِي إِسْرَائِيلَ وَبَعَثْنَا مِنْهُمُ اثْنَيْ عَشَرَ نَقِيبًا ۖ وَقَالَ اللَّهُ إِنِّي مَعَكُمْ ۖ لَئِنْ أَقَمْتُمُ الصَّلَاةَ وَآتَيْتُمُ الزَّكَاةَ وَآمَنْتُمْ بِرُسُلِي وَعَزَّرْتُمُوهُمْ وَأَقْرَضْتُمُ اللَّهَ قَرْضًا حَسَنًا لَأُكَفِّرَنَّ عَنْكُمْ سَيِّئَاتِكُمْ وَلَأُدْخِلَنَّكُمْ جَنَّاتٍ تَجْرِي مِنْ تَحْتِهَا الْأَنْهَارُ ۚ فَمَنْ كَفَرَ بَعْدَ ذَٰلِكَ مِنْكُمْ فَقَدْ ضَلَّ سَوَاءَ السَّبِيلِ",
        "interpretation": "🌊 این آیه درباره پیمان خداوند با بنی‌اسرائیل و وعده‌های او به آن‌هاست. انجام نماز، زکات و ایمان به پیامبران از شرایط این پیمان است. 🌿"
    },
    {
        "verse": "📖 مِنْ أَجْلِ ذَٰلِكَ كَتَبْنَا عَلَىٰ بَنِي إِسْرَائِيلَ أَنَّهُ مَنْ قَتَلَ نَفْسًا بِغَيْرِ نَفْسٍ أَوْ فَسَادٍ فِي الْأَرْضِ فَكَأَنَّمَا قَتَلَ النَّاسَ جَمِيعًا وَمَنْ أَحْيَاهَا فَكَأَنَّمَا أَحْيَا النَّاسَ جَمِيعًا ۚ وَلَقَدْ جَاءَتْهُمْ رُسُلُنَا بِالْبَيِّنَاتِ ثُمَّ إِنَّ كَثِيرًا مِنْهُمْ بَعْدَ ذَٰلِكَ فِي الْأَرْضِ لَمُسْرِفُونَ",
        "interpretation": "🕊️ این آیه ارزش زندگی انسان را بیان می‌کند. کشتن یک نفر برابر با کشتن همه انسان‌هاست و نجات یک نفر برابر با نجات همه انسان‌ها. 🌍"
    },
    {
        "verse": "📖 يَا أَيُّهَا الَّذِينَ آمَنُوا مَنْ يَرْتَدَّ مِنْكُمْ عَنْ دِينِهِ فَسَوْفَ يَأْتِي اللَّهُ بِقَوْمٍ يُحِبُّهُمْ وَيُحِبُّونَهُ أَذِلَّةٍ عَلَى الْمُؤْمِنِينَ أَعِزَّةٍ عَلَى الْكَافِرِينَ يُجَاهِدُونَ فِي سَبِيلِ اللَّهِ وَلَا يَخَافُونَ لَوْمَةَ لَائِمٍ ۚ ذَٰلِكَ فَضْلُ اللَّهِ يُؤْتِيهِ مَنْ يَشَاءُ ۚ وَاللَّهُ وَاسِعٌ عَلِيمٌ",
        "interpretation": "🛡️ این آیه درباره جایگزینی مؤمنان صالح به جای مرتدان است. آن‌ها با عشق به خدا و مؤمنان و دشمنی با کافران، در راه خدا جهاد می‌کنند. 🌟"
    },
    {
        "verse": "📖 وَمَا جَعَلَهُ اللَّهُ إِلَّا بُشْرَىٰ لَكُمْ وَلِتَطْمَئِنَّ قُلُوبُكُمْ بِهِ ۗ وَمَا النَّصْرُ إِلَّا مِنْ عِنْدِ اللَّهِ ۚ إِنَّ اللَّهَ عَزِيزٌ حَكِيمٌ",
        "interpretation": "🎉 این آیه به مؤمنان نوید پیروزی و آرامش قلب می‌دهد. پیروزی تنها از جانب خداوند است و او عزیز و حکیم است. 🌈"
    },
    {
        "verse": "📖 وَلَا تُجَادِلُوا أَهْلَ الْكِتَابِ إِلَّا بِالَّتِي هِيَ أَحْسَنُ إِلَّا الَّذِينَ ظَلَمُوا مِنْهُمْ ۖ وَقُولُوا آمَنَّا بِالَّذِي أُنْزِلَ إِلَيْنَا وَأُنْزِلَ إِلَيْكُمْ وَإِلَٰهُنَا وَإِلَٰهُكُمْ وَاحِدٌ وَنَحْنُ لَهُ مُسْلِمُونَ",
        "interpretation": "🤲 این آیه به مؤمنان توصیه می‌کند که با اهل کتاب به نیکوترین روش بحث کنند و ایمان خود را به کتاب‌های آسمانی و وحدانیت خداوند اعلام نمایند. 🌟"
    },
    {
        "verse": "📖 وَمِنْ آيَاتِهِ خَلْقُ السَّمَاوَاتِ وَالْأَرْضِ وَاخْتِلَافُ أَلْسِنَتِكُمْ وَأَلْوَانِكُمْ ۚ إِنَّ فِي ذَٰلِكَ لَآيَاتٍ لِلْعَالِمِينَ",
        "interpretation": "🌍 این آیه به نشانه‌های خداوند در آفرینش آسمان‌ها، زمین، زبان‌ها و رنگ‌های مختلف انسان‌ها اشاره می‌کند. این نشانه‌ها برای دانشمندان قابل درک است. 🌌"
    },
    {
        "verse": "📖 إِنَّ الَّذِينَ كَفَرُوا بِالذِّكْرِ لَمَّا جَاءَهُمْ ۖ وَإِنَّهُ لَكِتَابٌ عَزِيزٌ",
        "interpretation": "📜 این آیه درباره کافران است که قرآن را انکار کردند، در حالی که این کتابی عزیز و شکست‌ناپذیر است. 🌟"
    },
    {
        "verse": "📖 قُلْ يَا عِبَادِيَ الَّذِينَ أَسْرَفُوا عَلَىٰ أَنْفُسِهِمْ لَا تَقْنَطُوا مِنْ رَحْمَةِ اللَّهِ ۚ إِنَّ اللَّهَ يَغْفِرُ الذُّنُوبَ جَمِيعًا ۚ إِنَّهُ هُوَ الْغَفُورُ الرَّحِيمُ",
        "interpretation": "🌈 این آیه به بندگان گناهکار امید می‌دهد که از رحمت خداوند ناامید نشوند، زیرا او همه گناهان را می‌بخشد. 🌸"
    },
    {
        "verse": "📖 وَكَذَٰلِكَ أَوْحَيْنَا إِلَيْكَ قُرْآنًا عَرَبِيًّا لِتُنْذِرَ أُمَّ الْقُرَىٰ وَمَنْ حَوْلَهَا وَتُنْذِرَ يَوْمَ الْجَمْعِ لَا رَيْبَ فِيهِ ۚ فَرِيقٌ فِي الْجَنَّةِ وَفَرِيقٌ فِي السَّعِيرِ",
        "interpretation": "🔥 این آیه درباره نزول قرآن به زبان عربی و هشدار به مردم مکه و اطراف آن درباره روز قیامت است. در آن روز، گروهی به بهشت و گروهی به جهنم خواهند رفت. 🌟"
    },
    {
        "verse": "📖 إِنَّ الْمُصَّدِّقِينَ وَالْمُصَّدِّقَاتِ وَأَقْرَضُوا اللَّهَ قَرْضًا حَسَنًا يُضَاعَفُ لَهُمْ وَلَهُمْ أَجْرٌ كَرِيمٌ",
        "interpretation": "💰 این آیه به مردان و زنانی که صدقه می‌دهند و قرض الحسنه می‌پردازند، وعده پاداش مضاعف و کرامت می‌دهد. 🌟"
    },
    {
        "verse": "📖 إِنَّمَا النَّجْوَىٰ مِنَ الشَّيْطَانِ لِيَحْزُنَ الَّذِينَ آمَنُوا وَلَيْسَ بِضَارِّهِمْ شَيْئًا إِلَّا بِإِذْنِ اللَّهِ ۚ وَعَلَى اللَّهِ فَلْيَتَوَكَّلِ الْمُؤْمِنُونَ",
        "interpretation": "🛡️ این آیه درباره نجواهای پنهانی است که از شیطان سرچشمه می‌گیرد و باعث ناراحتی مؤمنان می‌شود. اما مؤمنان باید تنها بر خدا توکل کنند. 🌟"
    }

        
    ]
    try:
        logging.info("در حال ارسال آیه تصادفی...")
        verse = random.choice(verses)
        text = f"📖 آیه امروز:\n\"{verse['verse']}\"\n\n📚 تفسیر:\n{verse['interpretation']}\n\n🌟 از این آیه درس بگیرید و در زندگی خود به کار ببندید! 🌟"
        send_message(text)
    except Exception as e:
        logging.error(f"خطا در ارسال آیه تصادفی: {e}")

# زمان‌بندی وظایف
def schedule_tasks():
    try:
        logging.info("در حال تنظیم زمان‌بندی‌ها...")
        today_info = load_prayer_times()
        if not today_info:
            logging.warning("اطلاعات اوقات شرعی برای امروز یافت نشد.")
            return

        # ارسال اوقات شرعی در ابتدای روز
        schedule.every().day.at("00:01").do(send_daily_prayer_times)

        # زمان‌بندی اطلاع‌رسانی زمان هر نماز
        for prayer, time in today_info.items():
            if prayer in prayer_names:
                try:
                    schedule.every().day.at(time).do(
                        send_prayer_time_notification,
                        prayer,  # نام نماز
                        time  # زمان نماز
                    )
                    logging.info(f"زمان‌بندی اطلاع‌رسانی نماز {prayer_names[prayer]} برای ساعت {time} تنظیم شد.")
                except Exception as e:
                    logging.error(f"خطا در زمان‌بندی نماز {prayer_names[prayer]}: {e}")

                # زمان‌بندی اطلاع‌رسانی نیم ساعت قبل از نماز
               
                reminder_time = (datetime.strptime(time, "%H:%M:%S") - timedelta(minutes=30)).strftime("%H:%M:%S")
                schedule.every().day.at(reminder_time).do(
                    send_reminder_notification,
                    prayer,  # نام نماز
                    time  # زمان نماز
                )
                logging.info(f"زمان‌بندی اطلاع‌رسانی نیم ساعت قبل از نماز {prayer_names[prayer]} برای ساعت {reminder_time} تنظیم شد.")

        # زمان‌بندی ارسال اذکار صبح بعد از نماز صبح
        fajr_time = today_info['fajr']
        fajr_time_dt = datetime.strptime(fajr_time, "%H:%M:%S")
        supplication_time_fajr = (fajr_time_dt + timedelta(minutes=15)).strftime("%H:%M:%S")
        schedule.every().day.at(supplication_time_fajr).do(
            send_supplication, 
            os.path.join(audio_files_path, "اذکار صبح.mp3"),  # مسیر کامل به فایل صوتی
            "اذکار صبح 🌅"
        )
        logging.info(f"زمان‌بندی ارسال اذکار صبح برای ساعت {supplication_time_fajr} تنظیم شد.")

        # زمان‌بندی ارسال اذکار شب بعد از نماز عصر
        asr_time = today_info['asr']
        asr_time_dt = datetime.strptime(asr_time, "%H:%M:%S")
        supplication_time_asr = (asr_time_dt + timedelta(minutes=15)).strftime("%H:%M:%S")
        schedule.every().day.at(supplication_time_asr).do(
            send_supplication, 
            os.path.join(audio_files_path, "اذکار شب.mp3"),  # مسیر کامل به فایل صوتی
            "اذکار شب 🌙"
        )
        logging.info(f"زمان‌بندی ارسال اذکار شب برای ساعت {supplication_time_asr} تنظیم شد.")

        # زمان‌بندی ارسال اذکار قبل خواب بعد از نماز عشا
        isha_time = today_info['isha']
        isha_time_dt = datetime.strptime(isha_time, "%H:%M:%S")
        supplication_time_isha = (isha_time_dt + timedelta(minutes=15)).strftime("%H:%M:%S")
        schedule.every().day.at(supplication_time_isha).do(
            send_supplication, 
            os.path.join(audio_files_path, "اذکار قبل خواب.mp3"),  # مسیر کامل به فایل صوتی
            "اذکار قبل خواب 🌜"
        )
        logging.info(f"زمان‌بندی ارسال اذکار قبل خواب برای ساعت {supplication_time_isha} تنظیم شد.")

        # زمان‌بندی ارسال آیه تصادفی
        schedule.every().day.at("08:00").do(random_quranic_verse)
        logging.info("زمان‌بندی ارسال آیه تصادفی تنظیم شد.")

    except Exception as e:
        logging.error(f"خطا در زمان‌بندی وظایف: {e}")

# اجرای برنامه
try:
    logging.info("شروع برنامه...")
    schedule_tasks()

    # اجرای زمان‌بندی‌ها
    while True:
        schedule.run_pending()
        time.sleep(1)
except KeyboardInterrupt:
    logging.info("برنامه به صورت دستی متوقف شد.")
except Exception as e:
    logging.error(f"خطا رخ داد: {e}")
